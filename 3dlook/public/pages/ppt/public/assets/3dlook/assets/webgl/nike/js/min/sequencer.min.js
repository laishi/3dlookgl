var stopped=!1,sequencer={volume:.8,audioContext:null,sequencerRows:7,soundPaths:["sound/micha4/klickdrum.mp3","sound/micha4/Clap.mp3","sound/micha4/HihatClick.mp3","sound/micha4/HihatNoise.mp3","sound/micha4/Groove.mp3","sound/micha4/Pad.mp3","sound/micha4/Pad_freerun5.mp3","sound/ir_stairwell.mp3"],soundBuffers:[],triggerArray:[],ambientSounds:[],beatVol:.8,reverbAmount:.15,shuffle:!0,shuffleTime:.02,loopcount:3,tempo:110,lookahead:25,scheduleAheadTime:.1,isPlaying:!1,numSoundsReady:0,nextNoteTime:0,currentNote:0,loadingFailed:!1,grainPosition:.5,ambientSoundPlaying:!1,loopsNeedSync:!0,sequencer_currentMaxGroup:8,sleeps:!1,is_firefox:navigator.userAgent.toLowerCase().indexOf("firefox")>-1,is_safari:-1!=navigator.userAgent.toLowerCase().indexOf("safari")&&-1==navigator.userAgent.toLowerCase().indexOf("chrome"),initSequencer:function(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,$("#timeIndicator_"+this.currentNote).toggleClass("trigger_active")}catch(e){return this.loadingFailed=!0,alert("Web Audio API is not supported in this browser"),void 0}for(var t=0;t<this.soundPaths.length;t++){this.soundBuffers.push(0),this.triggerArray.push([]);for(var i=0;32>i;i++)this.triggerArray[t].push(0)}this.loadSounds(),this.is_firefox||this.is_safari||(this.bitCrusherIn=this.audioContext.createGain(),this.bitCrusherGain=this.audioContext.createGain(),this.bitCrusher=this.createBitCrusher(),this.bitCrusherBypass=this.audioContext.createGain(),this.bitCrusherOut=this.audioContext.createGain()),this.LFO=this.audioContext.createOscillator(),this.LPF=this.audioContext.createBiquadFilter(),this.LFOMultiplier=this.audioContext.createGain(),this.ambientSoundChannels=[];for(var t=0;t<this.loopcount;t++)this.ambientSoundChannels.push(this.audioContext.createGain());if(this.percussionChannel=this.audioContext.createGain(),this.mainOut=this.audioContext.createGain(),this.reverbIn=this.audioContext.createGain(),this.reverb=this.audioContext.createConvolver(),this.reverbChannel=this.audioContext.createGain(),this.noReverbChannel=this.audioContext.createGain(),this.reverbOut=this.audioContext.createGain(),this.delayIn=this.audioContext.createGain(),this.delayOut=this.audioContext.createGain(),this.delay1=this.audioContext.createDelay(),this.delay2=this.audioContext.createDelay(),this.is_firefox||this.is_safari||(this.bitCrusherIn.connect(this.bitCrusherGain),this.bitCrusherIn.connect(this.bitCrusherBypass),this.bitCrusherGain.connect(this.bitCrusher),this.bitCrusher.connect(this.bitCrusherOut),this.bitCrusherBypass.connect(this.bitCrusherOut)),this.reverbIn.connect(this.reverbChannel),this.reverbIn.connect(this.noReverbChannel),this.reverbChannel.connect(this.reverb),this.reverb.connect(this.reverbOut),this.noReverbChannel.connect(this.reverbOut),this.delayIn.connect(this.delay1),this.delayIn.connect(this.delay2),this.delay2.connect(this.delayOut),this.delay1.connect(this.delayOut),this.LFO.connect(this.LFOMultiplier),this.LFOMultiplier.connect(this.delay1.delayTime),this.is_firefox||this.is_safari){this.LPF.connect(this.reverbIn),this.reverbOut.connect(this.mainOut);for(var t=0;t<this.ambientSoundChannels.length;t++)this.ambientSoundChannels[t].connect(this.LPF);this.percussionChannel.connect(this.LPF)}else{this.bitCrusherOut.connect(this.LPF),this.LPF.connect(this.delayIn),this.delayOut.connect(this.reverbIn),this.reverbOut.connect(this.mainOut);for(var t=0;t<this.ambientSoundChannels.length;t++)this.ambientSoundChannels[t].connect(this.LPF);this.percussionChannel.connect(this.bitCrusherIn),this.setBitcrusherAmount(.1)}this.mainOut.connect(this.audioContext.destination),this.delay1.delayTime.value=.01,this.delay2.delayTime.value=.01,this.mainOut.gain.value=this.volume,this.LPF.type="lowpass",this.LPF.frequency.value=14200,this.LPF.Q.value=2,this.LFOMultiplier.gain.value=.001,this.LFO.type="sine",this.LFO.frequency.value=10,this.LFO.start(0),this.percussionChannel.gain.value=this.beatVol,this.reverbChannel.gain.value=this.reverbAmount,this.noReverbChannel.gain.value=1;for(var t=0;t<this.ambientSoundChannels.length;t++)this.ambientSoundChannels[t].gain.value=0;this.setPadValues(.5,.5)},sleep:function(){this.mainOut.disconnect(),this.sleeps=!0},wake:function(){this.mainOut.connect(this.audioContext.destination),this.sleeps=!1},setBitcrusherAmount:function(e){this.bitCrusherGain.gain.value=e,this.bitCrusherBypass.gain.value=1-e},setReverbAmount:function(e){this.reverbAmount=e,this.reverbChannel.gain.value=this.reverbAmount,this.noReverbChannel.gain.value=1-this.reverbAmount},initIfSoundsAreReady:function(){this.numSoundsReady==this.soundPaths.length&&(this.reverb.buffer=this.soundBuffers[7],this.scheduler()),$(window).focus(function(){sequencer.isPlaying&&sequencer.wake()}),$(window).blur(function(){sequencer.sleep()})},setPadValues:function(e,t){if(sequencer.is_firefox||sequencer.is_safari){var i=e,n=t;sequencer.LPF.frequency.value=13e3*i+300,sequencer.setReverbAmount(n)}else{var i=1-sequencer.capVal(2*t,0,1),n=1-sequencer.capVal(2*e,0,1),s=sequencer.capVal(2*(t-.5),0,1),r=sequencer.capVal(2*(e-.5),0,1);sequencer.LPF.frequency.value=13e3*(1-i)+300,sequencer.setReverbAmount(n),sequencer.LFOMultiplier.gain.value=.002*s,sequencer.LFO.frequency.value=5*s,sequencer.setBitcrusherAmount(.7*r)}},capVal:function(e,t,i){return t>e?t:e>i?i:e},loadSounds:function(){this.numSoundsReady=0;for(var e=0;e<this.soundPaths.length;e++)this.loadSound(this.soundPaths[e],e)},loadNewSoundSet:function(e){this.soundPaths=e,this.loadSounds()},loadSound:function(e,t){function i(e){sequencer.soundBuffers[t]=e,sequencer.numSoundsReady++,sequencer.initIfSoundsAreReady()}function n(){console.log("request error while loading "+e),sequencer.loadingFailed=!0}var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){sequencer.audioContext.decodeAudioData(s.response,i,n)},s.send()},playSound:function(e,t){if(null==e)return console.log("BUFFER IS NULL!"),void 0;var i=this.audioContext.createBufferSource();i.buffer=e,i.connect(this.percussionChannel),i.start(t)},scheduler:function(){if(!stopped){for(;sequencer.nextNoteTime<sequencer.audioContext.currentTime+sequencer.scheduleAheadTime;)sequencer.scheduleNote(sequencer.currentNote,sequencer.nextNoteTime),sequencer.nextNote();sequencer.isPlaying&&(sequencer.timerID=window.setTimeout(sequencer.scheduler,sequencer.lookahead))}},restartLoops:function(e){if(this.ambientSoundPlaying)for(var t=0;t<this.ambientSounds.length;t++)this.ambientSounds[t].stop(e),this.ambientSounds[t].disconnect();this.ambientSoundPlaying=!1,this.ambientSounds=[];for(var t=0;t<this.loopcount;t++)this.ambientSounds.push(this.audioContext.createBufferSource()),this.ambientSounds[t].buffer=this.soundBuffers[t+(7-this.loopcount)],this.ambientSounds[t].connect(this.ambientSoundChannels[t]),this.ambientSounds[t].loop=!0,this.ambientSounds[t].start(e);this.ambientSoundPlaying=!0},scheduleNote:function(e,t){if(this.loopsNeedSync&&0==e&&this.numSoundsReady==this.soundPaths.length&&(this.restartLoops(t),this.loopsNeedSync=!1),!this.sleeps){this.shuffle&&e%2&&(t+=this.shuffleTime);for(var i=0;i<7-this.loopcount;i++)i<this.sequencer_currentMaxGroup&&1==this.triggerArray[i][this.currentNote]&&this.playSound(this.soundBuffers[i],t);this.handleAmbient(e,t)}},nextNote:function(){var e=60/this.tempo;this.nextNoteTime+=.25*e;var t=this.currentNote-1;-1==t&&(t=31);var i=$("#timeIndicator_"+t),n=$("#timeIndicator_"+this.currentNote);i.removeClass("trigger_active"),n.addClass("trigger_active"),this.currentNote++,32==this.currentNote&&(this.currentNote=0)},handleAmbient:function(e,t){for(var i=7-this.loopcount,n=i;7>n;n++)if(n<this.sequencer_currentMaxGroup){var s=this.currentNote+1;32==s&&(s=0);var r=1==this.triggerArray[n][this.currentNote],a=1==this.triggerArray[n][s],o=30/this.tempo,u=(this.ambientSoundChannels[n-i].gain.value,t+o);!this.currentNote%2?u+=this.shuffleTime:u-=this.shuffleTime,a&&!r?(this.ambientSoundChannels[n-i].gain.setValueAtTime(0,u-.01),this.ambientSoundChannels[n-i].gain.linearRampToValueAtTime(1,u)):!a&&r?(this.ambientSoundChannels[n-i].gain.setValueAtTime(1,u-.1),this.ambientSoundChannels[n-i].gain.linearRampToValueAtTime(0,u)):a||this.ambientSoundChannels[n-i].gain.setValueAtTime(0,u)}},play:function(){sequencer.nextNoteTime=sequencer.audioContext.currentTime+.1,sequencer.isPlaying=!0,sequencer.wake(),sequencer.scheduler(),$("#button_play").removeClass("play_play"),$("#button_play").addClass("play_pause")},pause:function(){sequencer.isPlaying=!1,sequencer.sleep(),sequencer.loopsNeedSync=!0,$("#button_play").removeClass("play_pause"),$("#button_play").addClass("play_play")},togglePlay:function(){sequencer.isPlaying?sequencer.pause():sequencer.play()},toggleTrigger:function(e,t){sequencer.triggerArray[e][t]=0==sequencer.triggerArray[e][t]?1:0},clear:function(){for(var e=sequencer.sequencerRows-1;e>=0;e--)for(var t=31;t>=0;t--)sequencer.triggerArray[e][t]=0,$("#trigger_"+e+"_"+t).removeClass("trigger_active")},randomizeTriggers:function(){for(var e=sequencer.sequencerRows-1;e>=0;e--)for(var t=31;t>=0;t--)Math.random()>=.8?(sequencer.triggerArray[e][t]=1,$("#trigger_"+e+"_"+t).addClass("trigger_active")):(sequencer.triggerArray[e][t]=0,$("#trigger_"+e+"_"+t).removeClass("trigger_active"))},toggleShuffle:function(){sequencer.shuffle=!sequencer.shuffle},getState:function(){for(var e="",t=sequencer.sequencerRows-1;t>=0;t--)for(var i=31;i>=0;i--)e+=sequencer.triggerArray[t][i];return e+=sequencer.shuffle?"1":"0"},setState:function(e){for(var t=sequencer.sequencerRows-1;t>=0;t--)for(var i=31;i>=0;i--)sequencer.triggerArray[t][i]=e.charAt(31-i+32*(6-t));sequencer.shuffle=1==e.charAt(224)},createBitCrusher:function(){var e=this.audioContext.createScriptProcessor(0,1,1);e.bits=4,e.normfreq=.1;var t=Math.pow(.5,e.bits),i=0,n=0;return e.onaudioprocess=function(s){for(var r=s.inputBuffer.getChannelData(0),a=s.outputBuffer.getChannelData(0),o=0;o<e.bufferSize;o++)i+=e.normfreq,i>=1&&(i-=1,n=t*Math.floor(r[o]/t+.5)),a[o]=n},e},showSequencer:function(){$("#sequencerGrid").append('<div id="timeLine"><div/>');for(var e=0;32>e;e++)$("#timeLine").append('<div class="timeIndicator" id="timeIndicator_'+e+'"></div> ');$("#timeLine").append('<div class="clear"></div> ');for(var t=0;t<this.sequencerRows;t++){$("#sequencerGrid").append('<div id="triggerRow'+t+'" class="triggerRow"></div> ');for(var e=0;32>e;e++)$("#triggerRow"+t).append('<div class="trigger" id="trigger_'+t+"_"+e+'"></div> '),$("#trigger_"+t+"_"+e).data("beat",e),$("#trigger_"+t+"_"+e).data("sound",t),$("#trigger_"+t+"_"+e).bind("click",function(){var e=$(this).data("beat"),t=$(this).data("sound");$(this).toggleClass("trigger_active"),sequencer.toggleTrigger(t,e)});$("#triggerRow"+t).append('<div class="clear"></div> ')}$("#controls").append('<div class="trigger" style="width:50px;" id="play">play</div>'),$("#controls").append('<div class="trigger" style="width:50px;" id="shuffle">shuffle</div>'),$("#controls").append('<div class="trigger" style="width:50px;" id="clear">clear</div>'),$("#controls").append('<div class="trigger" style="width:80px;" id="randomize">randomize</div>'),$("#play").bind("click",function(){sequencer.togglePlay()}),$("#shuffle").bind("click",function(){sequencer.toggleShuffle()}),$("#clear").bind("click",function(){sequencer.clear()}),$("#randomize").bind("click",function(){sequencer.randomizeTriggers()})}};